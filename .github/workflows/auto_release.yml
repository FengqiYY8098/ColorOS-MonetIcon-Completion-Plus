name: Icon Update Release

permissions:
  contents: write

on:
  # 手动触发开关
  workflow_dispatch:
  # 自动触发条件
  push:
    paths:
      - 'uxicons/**'       # 监听图标变动
      - 'webui/**'         # 监听 WebUI 变动
    branches:
      - main # 确保你的主分支名正确，有的是 master

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整文件结构

      - name: Calculate Icon Count & Version
        id: version
        run: |
          # 1. 调试信息：打印 uxicons 目录内容到日志，方便排查
          echo "=== Debug: Listing directory content ==="
          ls -R uxicons || echo "Warning: uxicons directory not found"
          
          # 2. 计数逻辑修正
          # 只要是 uxicons 目录下的文件都算进去，排除文件夹本身
          if [ -d "uxicons" ]; then
            count=$(find uxicons -type f | wc -l)
          else
            count=0
          fi
          
          # 去除空格
          count=$(echo $count | xargs)
          
          # 3. 格式化版本号 (例如 v0.58.10)
          # 使用 ${count} + ${github.run_number} 确保唯一性
          # 这解决了 只修改 WebUI 但图标数不变导致 release 失败的问题
          
          # 去掉前导零，避免 octal 解析问题
          count_clean=$(echo $count | sed 's/^0*//')
          if [ -z "$count_clean" ]; then count_clean=0; fi
          
          version="v0.${count_clean}.${{ github.run_number }}"
          
          echo "Icon Count: $count"
          echo "Run Number: ${{ github.run_number }}"
          echo "Generated Version: $version"
          
          # 导出变量
          echo "ICON_COUNT=$count" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=$version" >> $GITHUB_OUTPUT

      - name: Prepare Assets
        run: |
          # 压缩图标包
          if [ -d "uxicons" ]; then
            zip -r uxicons.zip uxicons
          else
            echo "Error: uxicons directory missing!"
            exit 1
          fi
          
          # 准备 WebUI
          if [ -d "webui" ]; then
            cd webui
            zip -r ../webui.zip .
            cd ..
          else
            echo "Error: webui directory missing!"
            exit 1
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION_TAG }}
          name: ${{ steps.version.outputs.VERSION_TAG }} # 标题只写版本号
          body: "" # 内容留空
          files: |
            uxicons.zip
            webui.zip
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
